

# תיקון מדד "התראות נשלחו" בדשבורד

## הבעיה
בכרטיס "פעילות דיגיטלית" מוצגים שלושה מספרים:
- **הודעות נסרקו** (144) — `messages_scanned` ✅ נכון
- **הועברו לניתוח AI** (10) — `stacks_sent_to_ai` ✅ נכון
- **התראות נשלחו** (11) — `alerts_sent` ❌ **מטעה**

`alerts_sent` נספר ע"י טריגר `trg_alert_insert_to_daily_metrics` כשהמכשיר שולח התראה עם `risk_score >= 60`. זה **לא** אומר שההתראה נשלחה להורה — זה רק אומר שהמכשיר סימן את ההודעה כחשודה. לכן המספר (11) יכול להיות גדול מהמספר של "הועברו לניתוח AI" (10), כי התראות מערכת (כמו "מכשיר לא מגיב") נכנסות ישירות עם risk_score גבוה בלי לעבור דרך AI stack.

המדד הנכון ל"התראות שנשלחו להורים" הוא `notify_effective_today` שמגיע מה-view של `parent_alerts_effective` — זה סופר רק התראות שעברו את הסף ובאמת הוצגו להורה.

## פתרון

### קובץ: `src/pages/Dashboard.tsx`

**שינוי אחד** — בכרטיס Premium, להחליף את `alerts_sent` ב-`notify_effective_today`:

```
שורה 601:
- {snapshot.alerts_sent ?? 0}
+ {snapshot.notify_effective_today ?? 0}
```

זה מבטיח שהמספר המוצג תואם בדיוק למה שההורה קיבל בפועל — רק התראות שעברו ניתוח AI, עברו את הסף, ונשלחו כנוטיפיקציה.

## הערה לגבי הלוגיקה
- `notify_effective_today` כבר קיים ב-view של `parent_home_snapshot` ונטען ל-`HomeSnapshot`
- לא צריך שום שינוי בצד השרת
- המשפך ההגיוני נשמר: הודעות נסרקו (144) → הועברו ל-AI (10) → נשלחו להורה (מספר קטן יותר)

