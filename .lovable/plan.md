

# מוניטור כשלב ביניים + מד רגישות פעיל

## מצב נוכחי — מה גילינו

### חדשות טובות
- התראות `monitor` (סקור 25-59) כבר **מוסתרות** מההורה — דף ההתראות, הדשבורד והניווט התחתון מסננים רק `notify` ו-`review`
- כלומר "מוניטור" כבר עובד כשלב ביניים שקוף

### הבעיות
1. **מד הרגישות לא באמת עובד** — ההורה בוחר רמת רגישות (סף 50/65/85) בהגדרות, אבל הפרונטנד לא משתמש בזה. התראה עם סקור 62 (verdict=review) תוצג גם אם ההורה בחר "רק חמור" (סף 85)
2. **אין הסלמה** — אם הילד מקבל 3 התראות `monitor` מאותו צ'אט ב-48 שעות, שום דבר לא קורה. אין מנגנון שמזהה דפוס ומעלה את הרמה

## שינויים מוצעים

### שלב 1: מד רגישות פעיל (עדיפות גבוהה)

**מה ישתנה:** כל נקודה שמציגה התראות תסנן לפי `alert_threshold` של ההורה.

**קבצים:**

**`src/pages/Alerts.tsx`** — שליפת הסף מטבלת `settings` ושימוש בו:
- בטעינה ראשונית, שליפת `alert_threshold` מ-`settings` לפי ה-child_id הראשון (או שימוש ב-65 כברירת מחדל)
- סינון ההתראות ב-JavaScript: הצגה רק אם `ai_risk_score >= threshold`
- או לחלופין: שימוש ב-view `parent_alerts_effective` שכבר מטפל בזה

**`src/components/BottomNavigation.tsx`** — ספירת badge:
- במקום לספור כל `notify`+`review`, לשלוף מ-`parent_alerts_effective` (שכבר מסנן לפי סף)
- או לבצע join עם settings בשאילתה

**`src/pages/Dashboard.tsx`** — כרטיס התראות בדשבורד:
- אותו עיקרון — להציג רק התראות מעל הסף

**`src/pages/Family.tsx`** — ספירת התראות לכל ילד:
- סינון לפי סף

### שלב 2: שינוי שמות verdicts (נראות)

מכיוון ש-`monitor` כבר מוסתר, אין צורך בשינוי שם. אבל כדי שהמערכת תהיה ברורה גם פנימית:

| verdict נוכחי | שם פנימי (ללא שינוי) | משמעות |
|---|---|---|
| `safe` (0-24) | safe | לא מוצג, נשמר ל-training |
| `monitor` (25-59) | monitor | שלב ביניים — לא מוצג, ממתין להסלמה |
| `review` (60-79) | review | מוצג אם מעל סף הרגישות |
| `notify` (80-100) | notify | מוצג תמיד + Push |

### שלב 3: מנגנון הסלמה (אופציונלי — להחלטה)

מנגנון שבודק: "אם ב-48 שעות האחרונות יש 3+ התראות monitor מאותו chat_name, צור התראה review אוטומטית."

זה דורש:
- Edge function (cron או trigger) שסורקת monitor alerts
- לוגיקה שמזהה צבירה לפי chat_name + child_id
- יצירת התראת review מסונתזת עם הסבר "זוהה דפוס חוזר"

**המלצה:** לדחות לשלב הבא. קודם להפעיל את מד הרגישות שכבר בנינו.

## פירוט טכני

### שינוי 1: `src/pages/Alerts.tsx`
- הוספת שליפת `alert_threshold` מ-`settings` (לכל ילד או ברירת מחדל 65)
- סינון: `alerts.filter(a => (a.ai_risk_score ?? 0) >= threshold)`
- חל על שני הטאבים (חדשות + שמורות)

### שינוי 2: `src/components/BottomNavigation.tsx`
- שליפת הסף ובדיקה: count רק alerts עם `ai_risk_score >= threshold`
- אפשרות: שאילתת RPC או join עם settings

### שינוי 3: `src/pages/Dashboard.tsx`
- AlertsCard מקבל רק התראות מסוננות לפי סף

### שינוי 4: `src/pages/Family.tsx`
- ספירת התראות לכל ילד — רק מעל הסף

### אין שינוי ב-Edge Function
ה-verdict guard נשאר כמו שהוא. ה-DB שומר את כל ההתראות. הסינון הוא רק בצד הלקוח.

## סיכום

| מה | סטטוס |
|---|---|
| monitor מוסתר מההורה | כבר עובד |
| מד רגישות מסנן לפי סף | **לא עובד — צריך תיקון** |
| הסלמה מ-monitor ל-review | עדיין אין — שלב עתידי |

4 קבצים ישתנו, 0 שינויי DB, 0 שינויי edge function.
